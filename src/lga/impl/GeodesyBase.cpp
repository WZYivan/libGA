#include <lga/Geodesy>

M_libga_begin

    namespace config
{
    Geodesy geodesy = {};
}

namespace param
{
    const Geodesy geodesy = {};
}

const double
    rho0 = 57.295'779'513'082'321'0,
    rho1 = 3'437.746'770'784'939'17,
    rho2 = 206'264.806'247'096'355;

double
Latitude_Longitude_Base::sin() const noexcept
{
    return std::sin(m_rad);
}
double Latitude_Longitude_Base::cos() const noexcept
{
    return std::cos(m_rad);
}
double Latitude_Longitude_Base::tan() const noexcept
{
    return std::tan(m_rad);
}
double Latitude_Longitude_Base::csc() const noexcept
{
    return 1.0 / this->sin();
}
double Latitude_Longitude_Base::sec() const noexcept
{
    return 1.0 / this->cos();
}
double Latitude_Longitude_Base::cot() const noexcept
{
    return 1.0 / this->tan();
}

double Latitude_Longitude_Base::rad() const noexcept { return m_rad; }
double &Latitude_Longitude_Base::rad() noexcept { return m_rad; }

Latitude_Longitude_Base Latitude_Longitude_Base::fromAngle(const Angle &p_ang) { return Latitude_Longitude_Base(p_ang.toRadian()); }
Angle Latitude_Longitude_Base::toAngle() const noexcept { return Angle(m_rad); }

std::string Latitude_Longitude_Base::toString(std::string_view p_fmt) const noexcept
{
    if (p_fmt.empty())
    {
        return toAngle().toString();
    }
    else
    {
        return toAngle().toString(p_fmt);
    }
}

Latitude &Latitude::validate()
{
    if (std::abs(rad2deg(rad())) > 90.0)
    {
        throw std::invalid_argument(
            std::format(
                "Latitude value `{}` > 90.0",
                std::abs(rad2deg(rad()))));
    }
    return *this;
}
Longitude &Longitude::validate()
{
    if (std::abs(rad2deg(rad())) > 180.0)
    {
        throw std::invalid_argument(
            std::format(
                "Latitude value `{}` > 90.0",
                std::abs(rad2deg(rad()))));
    }
    return *this;
}

double
Ellipsoid_Quarter_Arc_Length_Adjust_Function::operator()(double p_len) const
{
    double x = p_len / 1e7;
    return sec2rad(sin_fn(x) + dg_fn(x) + cs_fn(x));
}

namespace internal
{
    Ellipsoid_Principle_Curvature_Radius_Linerization_Coefficient
    calcEllipsoid_Principle_Curvature_Radius_Linerization_Coefficient(
        const Ellipsoid_Geometry_Property &p_geometry)
    {
        double a = p_geometry.a, e2 = p_geometry.e1_2;
        double m0 = a * (1 - e2);
        double m2 = 3.0 / 2.0 * e2 * m0;
        double m4 = 5.0 / 4.0 * e2 * m2;
        double m6 = 7.0 / 6.0 * e2 * m4;
        double m8 = 9.0 / 8.0 * e2 * m6;
        double n0 = a;
        double n2 = 1.0 / 2.0 * e2 * n0;
        double n4 = 3.0 / 4.0 * e2 * n2;
        double n6 = 5.0 / 6.0 * e2 * n4;
        double n8 = 7.0 / 8.0 * e2 * n6;
        return {m0, m2, m4, m6, m8, n0, n2, n4, n6, n8};
    }

    Ellipsoid_Quarter_Arc_Linerization_Coefficient
    calcEllipsoid_Quarter_Arc_Linerization_Coefficient(
        const Ellipsoid_Principle_Curvature_Radius_Linerization_Coefficient &p_pre_coeff)
    {
        double
            m0 = p_pre_coeff.m0,
            m2 = p_pre_coeff.m2,
            m4 = p_pre_coeff.m4,
            m6 = p_pre_coeff.m6,
            m8 = p_pre_coeff.m8;

        double
            a0 = deg2rad(
                m0 +
                m2 / 2.0 +
                m4 * 3.0 / 8.0 +
                m6 * 5.0 / 16.0 +
                m8 * 35.0 / 128.0),
            a2 = (m2 / 2.0 +
                  m4 / 2.0 +
                  m6 * 15.0 / 32.0 +
                  m8 * 7.0 / 16.0) /
                 2.0,
            a4 = (m4 / 8.0 +
                  m6 * 3.0 / 16.0 +
                  m8 * 7.0 / 32.0) /
                 4.0,
            a6 = (m6 / 32.0 +
                  m8 / 16.0) /
                 6.0;
        return {a0, a2, a4, a6};
    }

    Ellipsoid
    calcEllipsoid_Property(
        const Ellipsoid_Geometry_Property &p_geo)
    {
        Ellipsoid_Principle_Curvature_Radius_Linerization_Coefficient
            prc_coeff =
                calcEllipsoid_Principle_Curvature_Radius_Linerization_Coefficient(p_geo);
        Ellipsoid_Quarter_Arc_Linerization_Coefficient
            qa_coeff =
                calcEllipsoid_Quarter_Arc_Linerization_Coefficient(prc_coeff);
        return Ellipsoid{
            .geometry{p_geo},
            .principle_curvature_radius_coeff{prc_coeff},
            .quarter_arc_coeff{qa_coeff}};
    }

    Ellipsoid
    calcKarsovski()
    {
        auto p{
            calcEllipsoid_Property({.a = 6'378'245,
                                    .b = 6'356'863.018'773'047'3,
                                    .c = 6'399'698.901'782'771'0,
                                    .alpha = 1.0 / 298.3,
                                    .e1_2 = 0.006'693'421'622'966,
                                    .e2_2 = 0.006'738'525'414'683})};

        p.quarter_arc_length_adjust_fn.sin_fn.a = 1.3082694492087268,
        p.quarter_arc_length_adjust_fn.sin_fn.b = 1.0002145971858798,
        p.quarter_arc_length_adjust_fn.sin_fn.c = 0.0005854719425683429;
        p.quarter_arc_length_adjust_fn.dg_fn.offset = -0.0023038979866213008;

        p.quarter_arc_length_adjust_fn.dg_fn.offset = -0.0023038979866213008,
        p.quarter_arc_length_adjust_fn.dg_fn.amp1 = 0.0026498159983222892,
        p.quarter_arc_length_adjust_fn.dg_fn.center1 = 0.2131336406624428,
        p.quarter_arc_length_adjust_fn.dg_fn.sigma1 = 0.20167166145188709,
        p.quarter_arc_length_adjust_fn.dg_fn.amp2 = 0.0026530214747364747,
        p.quarter_arc_length_adjust_fn.dg_fn.center2 = 0.7849910396116169,
        p.quarter_arc_length_adjust_fn.dg_fn.sigma2 = 0.20411477558695162;

        return p;
    }

    Ellipsoid
    calcIE1975()
    {
        auto p = calcEllipsoid_Property({.a = 6'378'140,
                                         .b = 6'356'755.288'157'528'7,
                                         .c = 6'399'596.651'988'010'5,
                                         .alpha = 1.0 / 298.257,
                                         .e1_2 = 0.006'694'384'999'588,
                                         .e2_2 = 0.006'739'501'819'473});

        p.quarter_arc_length_adjust_fn.sin_fn.a = 1.3086473387873636,
        p.quarter_arc_length_adjust_fn.sin_fn.b = 1.0001978904051434,
        p.quarter_arc_length_adjust_fn.sin_fn.c = 0.0005854724070249471;

        p.quarter_arc_length_adjust_fn.dg_fn.offset = -0.002304604685817817,
        p.quarter_arc_length_adjust_fn.dg_fn.amp1 = 0.0026506312176421552,
        p.quarter_arc_length_adjust_fn.dg_fn.center1 = 0.2131298357210478,
        p.quarter_arc_length_adjust_fn.dg_fn.sigma1 = 0.20166936609659156,
        p.quarter_arc_length_adjust_fn.dg_fn.amp2 = 0.002653836323793295,
        p.quarter_arc_length_adjust_fn.dg_fn.center2 = 0.7849780926138245,
        p.quarter_arc_length_adjust_fn.dg_fn.sigma2 = 0.20411007651540564;

        return p;
    }

    Ellipsoid
    calcWGS84()
    {
        auto p = calcEllipsoid_Property({.a = 6'378'137,
                                         .b = 6'356'752.314'2,
                                         .c = 6'399'593.625'8,
                                         .alpha = 1 / 298.257'223'563,
                                         .e1_2 = 0.006'694'379'990'13,
                                         .e2_2 = 0.006'739'496'742'77});

        p.quarter_arc_length_adjust_fn.sin_fn.a = 1.308645412315567,
        p.quarter_arc_length_adjust_fn.sin_fn.b = 1.0001974204047577,
        p.quarter_arc_length_adjust_fn.sin_fn.c = 0.0005855463063938729;

        p.quarter_arc_length_adjust_fn.dg_fn.offset = -0.0023048576875828097,
        p.quarter_arc_length_adjust_fn.dg_fn.amp1 = 0.002650920166500137,
        p.quarter_arc_length_adjust_fn.dg_fn.center1 = 0.2131322886065555,
        p.quarter_arc_length_adjust_fn.dg_fn.sigma1 = 0.2016704151835333,
        p.quarter_arc_length_adjust_fn.dg_fn.amp2 = 0.002654124014687272,
        p.quarter_arc_length_adjust_fn.dg_fn.center2 = 0.784979490418362,
        p.quarter_arc_length_adjust_fn.dg_fn.sigma2 = 0.2041091519216842;

        return p;
    }

    Ellipsoid
    calcCGCS2000()
    {
        auto p = calcEllipsoid_Property({.a = 6'378'137,
                                         .b = 6'356'752.314'1,
                                         .c = 6'399'593.625'9,
                                         .alpha = 1 / 298.257'222'101,
                                         .e1_2 = 0.006'694'380'022'90,
                                         .e2_2 = 0.006'739'496'775'48});

        p.quarter_arc_length_adjust_fn.sin_fn.a = 1.3086454276230437;
        p.quarter_arc_length_adjust_fn.sin_fn.b = 1.0001974166282752;
        p.quarter_arc_length_adjust_fn.sin_fn.c = 0.0005855305637564773;

        p.quarter_arc_length_adjust_fn.dg_fn.offset = -0.002304851335706558,
        p.quarter_arc_length_adjust_fn.dg_fn.amp1 = 0.0026509163109794173,
        p.quarter_arc_length_adjust_fn.dg_fn.center1 = 0.21313102107150536,
        p.quarter_arc_length_adjust_fn.dg_fn.sigma1 = 0.2016711030899239,
        p.quarter_arc_length_adjust_fn.dg_fn.amp2 = 0.00265411907874458,
        p.quarter_arc_length_adjust_fn.dg_fn.center2 = 0.7849789498882686,
        p.quarter_arc_length_adjust_fn.dg_fn.sigma2 = 0.20410811343744764;

#if (M_libga_hp)
        p.quarter_arc_length_adjust_fn.cs_fn.x = {0.0110574388549896, 0.0221149453356417, 0.0331725869872925, 0.0442304311947144, 0.0552885451020539, 0.0663469955330326, 0.0774058489115002, 0.0884651711824254, 0.0995250277334133, 0.1105854833168336, 0.1216466019726486, 0.132708446952025, 0.1437710806418147, 0.1548345644899905, 0.1658989589321189, 0.1769643233189536, 0.1880307158452333, 0.1990981934797632, 0.2101668118968621, 0.2212366254092524, 0.2323076869024751, 0.2433800477709015, 0.2544537578554224, 0.2655288653828859, 0.276605416907357, 0.2876834572532729, 0.29876302946056, 0.3098441747317843, 0.3209269323813978, 0.3320113397871493, 0.3430974323437188, 0.3541852434186368, 0.3652748043105478, 0.3763661442098727, 0.3874592901619242, 0.3985542670325264, 0.4096510974761874, 0.4207498019068706, 0.4318503984714098, 0.4429529030256046, 0.4540573291130398, 0.4651636879466584, 0.476271988393123, 0.487382236959992, 0.4984944377857385, 0.5096085926326323, 0.5207247008825037, 0.5318427595354058, 0.5429627632111854, 0.5540847041539723, 0.565208572239591, 0.5763343549858939, 0.5874620375660186, 0.5985916028245553, 0.6097230312966205, 0.6208563012298189, 0.631991388609077, 0.6431282671843249, 0.6542669085010037, 0.6654072819333634, 0.6765493547205244, 0.6876930920052561, 0.6988384568754413, 0.7099854104081712, 0.7211339117164293, 0.7322839179983056, 0.7434353845886882, 0.754588265013369, 0.7657425110454996, 0.7768980727643331, 0.7880548986161718, 0.7992129354774592, 0.810372128719923, 0.8215324222777013, 0.8326937587163575, 0.8438560793037029, 0.8550193240823338, 0.8661834319437882, 0.8773483407042324, 0.8885139871815707, 0.8996803072738866, 0.910847236039104, 0.922014707775774, 0.9331826561048676, 0.944351014052479, 0.9555197141333206, 0.9666886884349036, 0.9778578687022892, 0.9890271864233002};

        p.quarter_arc_length_adjust_fn.cs_fn.y = {1.065105198290331e-05, 3.5845362148063335e-06, -1.2424809764587878e-06, -4.2257245972762854e-06, -5.732288648950816e-06, -6.097378024773478e-06, -5.621870939556673e-06, -4.570751190546756e-06, -3.1723977730239877e-06, -1.6186313377433389e-06, -6.554204153735345e-08, 1.3650031186464523e-06, 2.5832849001201095e-06, 3.5291651014169667e-06, 4.169022198540037e-06, 4.492516669453461e-06, 4.509063496951004e-06, 4.244186604630547e-06, 3.735957520074667e-06, 3.0314465871255887e-06, 2.1833551233308096e-06, 1.2470096767118076e-06, 2.773958927695464e-07, -6.732696145618218e-07, -1.5574159982754444e-06, -2.334038331049484e-06, -2.9698315231227283e-06, -3.4399423543858684e-06, -3.728568393702292e-06, -3.828822652883062e-06, -3.7426863491468883e-06, -3.4800929652921897e-06, -3.0582977523438957e-06, -2.500818778178402e-06, -1.836106632000119e-06, -1.096088892880813e-06, -3.150761857574364e-07, 4.7188895805532274e-07, 1.2302758174734208e-06, 1.9276600818085316e-06, 2.534523056831571e-06, 3.0256170396699344e-06, 3.3806547461976734e-06, 3.5851226043948038e-06, 3.6308756072691087e-06, 3.516106090027454e-06, 3.245543948932582e-06, 2.830449566958203e-06, 2.287951564500278e-06, 1.640606001550391e-06, 9.153844942107626e-07, 1.4320846088719877e-07, -6.428144304867264e-07, -1.4080826413796852e-06, -2.11812133290158e-06, -2.7399595661930804e-06, -3.243314139789698e-06, -3.601909892899085e-06, -3.7951326733597253e-06, -3.8085211400704436e-06, -3.6353894582604428e-06, -3.2770311289911924e-06, -2.7435550666379815e-06, -2.0536358008760476e-06, -1.2348949840128125e-06, -3.229165889207311e-07, 6.396968252196829e-07, 1.6041073148337706e-06, 2.517737390295583e-06, 3.3258088055414074e-06, 3.974202518550879e-06, 4.411849539071207e-06, 4.594261689818378e-06, 4.4865679636445915e-06, 4.0670815428735414e-06, 3.3310420302448164e-06, 2.293653737219306e-06, 9.941600965976925e-07, -5.017151761357343e-07, -2.0979878567980483e-06, -3.6668000458809323e-06, -5.045617320377071e-06, -6.0367928155693334e-06, -6.405855305036557e-06, -5.882286295744513e-06, -4.160173283344285e-06, -8.994613611100748e-07, 4.271019138663229e-06, 1.1750038532456998e-05};

        p.quarter_arc_length_adjust_fn.cs_fn.a = {1.038605396842306e-05, 3.0862783501076024e-06, -1.1316668136375322e-06, -3.961059516429101e-06, -5.701177596913286e-06, -5.752768979785241e-06, -5.4047676801884275e-06, -4.609981220107576e-06, -3.3003490057474526e-06, -1.7762338381658401e-06, -1.788163224716047e-07, 1.3273426810526932e-06, 2.5524942545057907e-06, 3.3298016571928637e-06, 4.083618090443442e-06, 4.7016313032502565e-06, 4.740264898795838e-06, 4.201261995967344e-06, 3.700099024928939e-06, 3.1714280574703628e-06, 2.2462959083332464e-06, 1.0223218302855354e-06, 1.0126054292796637e-08, -7.886412878534477e-07, -1.5653583450438478e-06, -2.190943139078786e-06, -2.7796779072872105e-06, -3.323356904192184e-06, -3.647954793581261e-06, -3.7570241725528396e-06, -3.744607652147152e-06, -3.5731787967254046e-06, -3.176865501597422e-06, -2.554049403132278e-06, -1.8873914536800647e-06, -1.1745513562781496e-06, -3.120471133830203e-07, 6.609026211684432e-07, 1.4580325028066094e-06, 2.05666784082084e-06, 2.560861239220733e-06, 2.886221973664328e-06, 3.1865661624537996e-06, 3.457763729929373e-06, 3.5420759437229973e-06, 3.460210657690154e-06, 3.2588791748227463e-06, 2.9102270943795617e-06, 2.393112654103166e-06, 1.7035394992558354e-06, 9.766069538009717e-07, 2.1672519190739795e-07, -6.519810715620554e-07, -1.5970631890965765e-06, -2.344146264251342e-06, -2.8675799607537615e-06, -3.268440560353525e-06, -3.4639833637939796e-06, -3.6035581601403313e-06, -3.6825414910866597e-06, -3.5461849727240316e-06, -3.214044727930743e-06, -2.754707530966975e-06, -2.142730586840452e-06, -1.345762031131074e-06, -3.6611529525037614e-07, 5.940142899250882e-07, 1.5227477183049724e-06, 2.5212503114826806e-06, 3.5362903639717393e-06, 4.223706347489581e-06, 4.545567663295633e-06, 4.614028562945259e-06, 4.319933176882155e-06, 3.855139415074198e-06, 3.2068811673753954e-06, 2.1696899836848125e-06, 7.63975891919636e-07, -6.145144023601156e-07, -1.9716751090385365e-06, -3.5004423249308166e-06, -5.111997922230352e-06, -6.018912713344661e-06, -6.143914669307926e-06, -5.561149233334107e-06, -4.009032597056084e-06, -7.604941157000828e-07, 4.391233811546885e-06};

        p.quarter_arc_length_adjust_fn.cs_fn.b = {-0.0008585844545633476, -0.0004912765876398977, -0.0003011571486525086, -0.0002160638489929557, -7.428789163487478e-05, 2.713253715396033e-05, 4.6166308777463896e-05, 9.820276024767493e-05, 0.00013185797443742594, 0.00014300013107349278, 0.00014278906861078233, 0.00012757005612840913, 8.764602349397384e-05, 6.486506934646603e-05, 6.805943218456623e-05, 3.4840713658381e-05, -2.939287542908036e-05, -5.289715316207346e-05, -4.0957651310055626e-05, -6.237950626194538e-05, -0.00010348475315369074, -0.00010599813867896376, -7.837012188818951e-05, -7.110700313625407e-05, -6.393752731728293e-05, -5.2924471375352105e-05, -5.318753818904228e-05, -4.0926557500174464e-05, -1.8163936792136765e-05, -3.8045995532207795e-06, 7.222113648803375e-06, 2.465809906908062e-05, 4.773947431540862e-05, 6.0054566822042446e-05, 6.079161343830702e-05, 6.981461653468015e-05, 8.587118578318549e-05, 8.286514551465603e-05, 6.108918751624541e-05, 4.996565641341337e-05, 3.701932189523007e-05, 2.60583394168068e-05, 2.7745538297954584e-05, 1.7301908263499593e-05, -9.60166345551974e-07, -1.2795453614325354e-05, -2.4289873948895624e-05, -3.845611615486967e-05, -5.547089753521385e-05, -6.517127333716868e-05, -6.589419972159625e-05, -7.219599062045758e-05, -8.441983262470193e-05, -7.907398405313784e-05, -5.537959599504214e-05, -4.1799607207786816e-05, -2.6467437888533348e-05, -1.3006490283446643e-05, -1.1773085382722503e-05, 1.237133840814036e-06, 2.226719481493278e-05, 3.58219994022317e-05, 4.7499343294460974e-05, 6.252195999844248e-05, 8.157403018990772e-05, 8.922216631286584e-05, 8.341655976974057e-05, 8.522763131281438e-05, 9.404445413825909e-05, 8.011591637994851e-05, 4.330460209537625e-05, 1.8046539334257132e-05, -1.054813970183445e-05, -3.650288689935384e-05, -4.742531131764753e-05, -7.295164185131739e-05, -0.00011372707344978673, -0.00012861327129926254, -0.00011996040445896274, -0.00012658787305377267, -0.00014905757191906353, -0.00012085247852493666, -4.411082331128594e-05, 2.008435091488096e-05, 8.673371084492147e-05, 0.00020643045201009045, 0.00037701445529027955, 0.0005418063013628196};

        p.quarter_arc_length_adjust_fn.cs_fn.c = {0.020615077287628972, 0.012602888043537458, 0.0045906008555177905, 0.0031046874903280577, 0.009716301563147078, -0.0005449959248164084, 0.0022661302026759627, 0.0024390814003002973, 0.0006039249926483331, 0.00040346177836037125, -0.00042254325368651174, -0.0009532681512597191, -0.002655640337799561, 0.00059652817565146, -0.0003078216535902608, -0.002694223047776109, -0.003110160714585828, 0.0009864358235897887, 9.224458638564144e-05, -0.002027404101757111, -0.001685450976945913, 0.0014584546249357408, 0.0010364650162596096, -0.00038065930657013624, 0.0010279253625381708, -3.379141844299333e-05, 1.0048009512715454e-05, 0.00109642432604156, 0.0009574526446266189, 0.0003380011142694298, 0.0006566426834219248, 0.0009158936181497765, 0.0011654669939880837, -5.513292989691443e-05, 0.00012157455244929144, 0.0006916766333446098, 0.0007552743072888495, -0.0010261203584927229, -0.0009355722290907044, -6.632162724906144e-05, -0.001099549928493225, 0.00011263939889240442, 3.924692154690199e-05, -0.0009792465958654531, -0.0006641789411118064, -0.0004007052027402274, -0.0006333275788947678, -0.0006408375112737606, -0.0008892682221806293, 1.708450426167912e-05, -8.207326346515963e-05, -0.0004843399986449042, -0.0006141674323702036, 0.0010944960388684299, 0.0010341066034211587, 0.0001856598145977758, 0.0011912642091699713, 1.7418054368762833e-05, 9.331402377772295e-05, 0.0010745300617486572, 0.0008129159616117164, 0.0004034447835281281, 0.0006442861816076192, 0.0007034019252703649, 0.0010055336226272465, -0.000319602518230495, -0.0002010112051816578, 0.0003633971964333957, 0.0004270482357407883, -0.0016756216477632094, -0.0016238216503057905, -0.0006398438201634454, -0.0019225886437964817, -0.00040304437500794454, -0.0005755503012052779, -0.001711279783446559, -0.0019413707144196968, 0.000607972825917348, 0.00016703277654273746, -0.0007605916545047986, -0.0012516826381472187, 0.0037774526136824505, 0.0030944389857078193, 0.002653722837259435, 0.0033139727042588163, 0.00740318688448265, 0.00786983628435133, 0.006884321328606023};

        p.quarter_arc_length_adjust_fn.cs_fn.d = {-0.2415309231519428, -0.24153092315193947, -0.044792135408346374, 0.19929902839430721, -0.30930486303993976, 0.08473229641709042, 0.005212832920121451, -0.05530983152724644, -0.006041439335418571, -0.02489214872833372, -0.015992657601050526, -0.051294963877997445, 0.09798506383946012, -0.027245046681703772, -0.07188801955240716, -0.012528553330032931, 0.12338242050126115, -0.026928721770213368, -0.06382669065955063, 0.01029570425625807, 0.09464725241650182, -0.012702445866689728, -0.04265193571305832, 0.042389386443857174, -0.03194658826015765, 0.0013189266136368614, 0.03267942346927991, -0.004179816546524971, -0.018628315966197306, 0.009580819918486421, 0.007793871816422217, 0.007501751069342684, -0.03668327226359447, 0.00530980971223109, 0.017127933584848657, 0.0019103855606076683, -0.053501579903829935, 0.002719016912756836, 0.026097733101528534, -0.031015509584755248, 0.036381240258999865, -0.0022023314217211776, -0.030557177644957644, 0.009451102732162308, 0.007902047494123151, -0.0069755340905762325, -0.00022515718536376194, -0.007446961294565277, 0.02716410535129736, -0.0029713215751822272, -0.012052087910051936, -0.003889022797888236, 0.051174909098629484, -0.0018083763342929373, -0.02540274312680863, 0.03010317327925031, -0.0351339065930053, 0.0022712515602573103, 0.029359160592132682, -0.007826613746962223, -0.012248170358568906, 0.007203036146555834, 0.001767769806317107, 0.009033551954739262, -0.03961540790076126, 0.0035448644680547187, 0.01686883806763915, 0.0019021467736454404, -0.06282874666765673, 0.001547632458231453, 0.029395189684792482, -0.03831653405289296, 0.045385433065945446, -0.005151889804159962, -0.033915572583501696, -0.006870491377011184, 0.07611724919340246, -0.013164461941591392, -0.027692811545670666, -0.014659887339260332, 0.15011991681169454, -0.02038699668943746, -0.013154196141239778, 0.019705966627517117, 0.12204387113466414, 0.013926954772756933, -0.02941173634807118, -0.029411736348074716};
        p.quarter_arc_length_adjust_fn.cs_fn.threshold = {1.1260702102689778e-05};
#endif
        return p;
    }
}

const Ellipsoid
    krasovski{internal::calcKarsovski()},
    ie1975{internal::calcIE1975()},
    wgs84{internal::calcWGS84()},
    cgcs2000{internal::calcCGCS2000()};

Ellipsoid_Geometry_Latitude_Aux::Ellipsoid_Geometry_Latitude_Aux(
    Latitude p_lat,
    const Ellipsoid &p_ellipsoid) : b(p_lat)
{
    const Ellipsoid_Geometry_Property &geometry = p_ellipsoid.geometry;
    t = b.tan();
    nu_2 = geometry.e2_2 * std::pow(b.cos(), 2);
    w = std::sqrt(1 - geometry.e1_2 * std::pow(b.sin(), 2));
    v = std::sqrt(1 + nu_2);
}

Ellipsoid_Principle_Curvature_Radius principleCurvatureRadius(
    const Latitude &p_lat,
    const Ellipsoid &p_ellipsoid)
{
    const Ellipsoid_Geometry_Property &geo = p_ellipsoid.geometry;
    double sinBp2 = std::pow(p_lat.sin(), 2),
           a = geo.a,
           e1_2 = geo.e1_2,
           k = 1.0 - e1_2 * sinBp2;
    double M = a * (1.0 - e1_2) * std::pow(k, -1.5),
           N = a * std::pow(k, -0.5);
    return {
        .m = M,
        .n = N};
}
double meanCurvatureRadius(const Ellipsoid_Principle_Curvature_Radius &p_pcr)
{
    return std::sqrt(p_pcr.m * p_pcr.n);
}

double meridianArcLength(const Latitude &p_lat, const Ellipsoid &p_ellipsoid)
{
    const Ellipsoid_Quarter_Arc_Linerization_Coefficient &
        coeff{p_ellipsoid.quarter_arc_coeff};
    double a0 = coeff.a0,
           a2 = coeff.a2,
           a4 = coeff.a4,
           a6 = coeff.a6;
    double B = p_lat.rad(),
           sin2B = std::sin(2 * B),
           sin4B = std::sin(4 * B),
           sin6B = std::sin(6 * B);
    double X = a0 * rad2deg(B) -
               a2 * sin2B +
               a4 * sin4B -
               a6 * sin6B;
    return X;
}

Latitude meridianArcBottom(double p_len, const Ellipsoid &p_ellipsoid)
{
    const auto &
        coeff{p_ellipsoid.quarter_arc_coeff};

    double Bf_cur = deg2rad(p_len / coeff.a0), Bf_next = Bf_cur, FB = 0; // rad
    double dB = (p_ellipsoid.quarter_arc_length_adjust_fn)(p_len);

    if (eqApprox(Bf_cur, 0.0))
    {
        return Latitude(Bf_cur);
    }

    do
    {
        Bf_cur = Bf_next;
        FB =
            -coeff.a2 * std::sin(2 * Bf_cur) +
            coeff.a4 * std::sin(4 * Bf_cur) -
            coeff.a6 * std::sin(6 * Bf_cur);
        Bf_next = deg2rad((p_len - FB) / coeff.a0); // deg -> rad
    } while (Bf_next - Bf_cur >= config::geodesy.meridian_arc_buttom.threshold);
    return Latitude(Bf_cur + dB); // return rad
}

M_libga_end